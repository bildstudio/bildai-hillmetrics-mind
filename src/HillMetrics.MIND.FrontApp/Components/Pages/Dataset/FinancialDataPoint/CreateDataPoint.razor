@page "/financial-data/create"
@page "/financial-data/edit/{Id:int?}"
@using HillMetrics.MIND.API.Contracts.Requests.AiDataset
@using HillMetrics.Normalized.Domain.Contracts.AI.Dataset
@using HillMetrics.MIND.API.SDK.V1
@using HillMetrics.Core.Financial
@inject IMindAPI MindApi
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">@(IsEditMode ? "Edit" : "Create") Financial Data Point</MudText>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudCard Class="mb-6">
        <MudCardContent>
            <MudTextField @bind-Value="dataPoint.Name"
                          Label="Data Point Name"
                          Required="true"
                          RequiredError="Name is required" />
        </MudCardContent>
    </MudCard>

    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h5">Elements</MudText>
        <MudText Typo="Typo.caption" Color="Color.Info">
            <MudIcon Icon="@Icons.Material.Filled.DragIndicator" Size="Size.Small" Class="mr-1" />
            Drag elements to reorder them
        </MudText>
    </div>

    <MudDragDropZone T="ElementViewModel"
                     Items="elements"
                     ItemDraggable="true"
                     ItemDropped="ItemDropped"
                     Class="mud-height-full">
        <ChildContent>
            @foreach (var element in elements)
            {
                <MudDragDropItem T="ElementViewModel"
                                 Item="element"
                                 Class="mb-4">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudAvatar Color="Color.Primary" Size="Size.Small">@(element.Position)</MudAvatar>
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.body1">
                                    @(string.IsNullOrEmpty(element.PropertyName) ? "New Element" : element.PropertyName)
                                </MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.DragIndicator"
                                               Size="Size.Small"
                                               Class="drag-handle" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudGrid>
                                <MudItem xs="12" md="4">
                                    <MudTextField @bind-Value="element.PropertyName"
                                                  Label="Property Name"
                                                  Required="true" />
                                </MudItem>
                                <MudItem xs="12" md="8">
                                    <MudTextField @bind-Value="element.Description"
                                                  Label="Description" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudSelect T="PropertyDataType"
                                               @bind-Value="element.DataType"
                                               Label="Default Data Type">
                                        <MudSelectItem Value="PropertyDataType.Column">Column</MudSelectItem>
                                        <MudSelectItem Value="PropertyDataType.Fixed">Fixed Value</MudSelectItem>
                                        <MudSelectItem Value="PropertyDataType.Row">Row</MudSelectItem>
                                        <MudSelectItem Value="PropertyDataType.Deductive">Deductive</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12">
                                    <MudExpansionPanels>
                                        <MudExpansionPanel Text="Potential Values">
                                            <MudChipSet T="ElementViewModel" @bind-SelectedChips="element.ChipValues"
                                                        MultiSelection="true"
                                                        Filter="true"
                                                        Mandatory="false"
                                                        OnClose="@(() => RemoveValue(element))">
                                                @foreach (var value in element.PotentialValues)
                                                {
                                                    <MudChip Text="@value" Value="@value" />
                                                }
                                            </MudChipSet>
                                            <MudGrid Class="mt-2">
                                                <MudItem xs="8">
                                                    <MudTextField @bind-Value="element.NewValue"
                                                                  Label="Add New Value" />
                                                </MudItem>
                                                <MudItem xs="4">
                                                    <MudButton OnClick="() => AddValue(element)"
                                                               Color="Color.Primary"
                                                               Variant="Variant.Filled"
                                                               Class="mt-4">
                                                        Add Value
                                                    </MudButton>
                                                </MudItem>
                                            </MudGrid>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton OnClick="() => RemoveElement(element)"
                                       Color="Color.Error"
                                       StartIcon="@Icons.Material.Filled.Delete">
                                Remove Element
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudDragDropItem>
            }
        </ChildContent>
        <EmptyZoneContent>
            <MudAlert Severity="Severity.Info">No elements added yet. Click "Add Element" to start.</MudAlert>
        </EmptyZoneContent>
    </MudDragDropZone>

    <MudButton OnClick="AddElement"
               Color="Color.Primary"
               Variant="Variant.Outlined"
               StartIcon="@Icons.Material.Filled.Add"
               Class="mb-4 mt-4">
        Add Element
    </MudButton>

    <MudDivider Class="my-6" />

    <MudButton OnClick="SaveDataPoint"
               Color="Color.Primary"
               Variant="Variant.Filled"
               Size="Size.Large"
               Disabled="@(!CanSave())">
        @(IsEditMode ? "Update" : "Save") Data Point
    </MudButton>
}

<style>
    .mud-card.mud-drag-item {
        cursor: move;
    }

    .drag-handle {
        cursor: move;
    }
</style>

@code {
    [Parameter]
    public int? Id { get; set; }

    private bool IsEditMode => Id.HasValue;
    private FinancialDataPoint dataPoint = new();
    private List<ElementViewModel> elements = new();
    private bool isLoading = true;

    private class ElementViewModel
    {
        public int? ElementId { get; set; }
        public string PropertyName { get; set; } = string.Empty;
        public string? Description { get; set; }
        public PropertyDataType DataType { get; set; } = PropertyDataType.Column;
        public List<string> PotentialValues { get; set; } = new();
        public MudChip<ElementViewModel>[] ChipValues { get; set; } = Array.Empty<MudChip<ElementViewModel>>();
        public string NewValue { get; set; } = string.Empty;
        public int Position { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            await LoadDataPoint();
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadDataPoint()
    {
        try
        {
            var result = await MindApi.GetFinancialDataPointAsync(Id!.Value);

            // if (!result.IsSuccess)
            // {
            //     Snackbar.Add(result.Error ?? "Failed to load data point", Severity.Error);
            //     NavigationManager.NavigateTo("/financial-data/list");
            //     return;
            // }

            dataPoint = result.Data;

            elements = dataPoint.Elements
                .OrderBy(e => e.Position)
                .Select((e, index) => new ElementViewModel
                    {
                        ElementId = e.Id,
                        PropertyName = e.PropertyName,
                        Description = e.Description,
                        DataType = PropertyDataType.Column,
                        PotentialValues = e.PotentialValues.ToList(),
                        // ChipValues = e.PotentialValues.Select(v => new MudChip<ElementViewModel> { Text = v, Value = v }).ToArray(),
                        Position = e.Position ?? (index + 1)
                    }).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AddElement()
    {
        int nextPosition = elements.Count > 0 ? elements.Max(e => e.Position) + 1 : 1;
        elements.Add(new ElementViewModel { Position = nextPosition });
    }

    private void RemoveElement(ElementViewModel element)
    {
        elements.Remove(element);
        UpdateElementPositions();
    }

    private void ItemDropped(MudItemDropInfo<ElementViewModel> dropInfo)
    {
        elements.Remove(dropInfo.Item);
        elements.Insert(dropInfo.IndexInZone, dropInfo.Item);
        UpdateElementPositions();
    }

    private void UpdateElementPositions()
    {
        for (int i = 0; i < elements.Count; i++)
        {
            elements[i].Position = i + 1;
        }
    }

    private void AddValue(ElementViewModel element)
    {
        if (!string.IsNullOrWhiteSpace(element.NewValue) &&
            !element.PotentialValues.Contains(element.NewValue))
        {
            element.PotentialValues.Add(element.NewValue);
            element.NewValue = string.Empty;
        }
    }

    private void RemoveValue(ElementViewModel element)
    {
        var selectedValues = element.ChipValues.Select(c => c.Text).ToList();
        element.PotentialValues.RemoveAll(v => selectedValues.Contains(v));
    }

    private bool CanSave()
    {
        if (string.IsNullOrWhiteSpace(dataPoint.Name))
            return false;

        if (elements.Count == 0)
            return false;

        return elements.All(e => !string.IsNullOrWhiteSpace(e.PropertyName));
    }

    private async Task SaveDataPoint()
    {
        try
        {
            if (IsEditMode)
            {
                var updateRequest = new CreateFinancialDataPointRequest
                    {
                        Name = dataPoint.Name,
                        Elements = elements.Select(e => new FinancialDataPointElement
                        {
                            Id = e.ElementId.Value,
                            PropertyName = e.PropertyName,
                            Description = e.Description,
                            FinancialDataPointId = dataPoint.Id,
                            // DefaultDataType = e.DataType,
                            PotentialValues = e.PotentialValues,
                            Position = e.Position
                        }).ToList()
                    };

                var result = await MindApi.UpdateFinancialDataPointAsync(dataPoint.Id, updateRequest);
                Snackbar.Add("Financial data point updated successfully", Severity.Success);
                NavigationManager.NavigateTo("/financial-data/list");

                // if (result.IsSuccess)
                // {
                //     Snackbar.Add("Financial data point updated successfully", Severity.Success);
                //     NavigationManager.NavigateTo("/financial-data/list");
                // }
                // else
                // {
                //     Snackbar.Add(result.Error ?? "Failed to update data point", Severity.Error);
                // }
            }
            else
            {
                var createCommand = new CreateFinancialDataPointRequest
                    {
                        Name = dataPoint.Name,
                        Elements = elements.Select(e => new FinancialDataPointElement
                        {
                            PropertyName = e.PropertyName,
                            Description = e.Description,
                            FinancialDataPointId = dataPoint.Id,
                            // DefaultDataType = e.DataType,
                            PotentialValues = e.PotentialValues,
                            Position = e.Position
                        }).ToList()
                    };

                var result = await MindApi.CreateFinancialDataPointAsync(createCommand);

                if (result.Data != null)
                {
                    Snackbar.Add("Financial data point created successfully", Severity.Success);
                    NavigationManager.NavigateTo("/financial-data/list");
                }
                else
                {
                    Snackbar.Add("Failed to create data point", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving data point: {ex.Message}", Severity.Error);
        }
    }
}